

### 钉钉企业级IM存储架构创新之道

摘要：

* 没有成本的优化，业务的增长带来的是不可持续的成本增长
* 框架战略继承母体基因-大中台，小前台；
  聚焦在核心能力的开发，如 IM核心系统、系统单元化、音视频通讯、弱网优化、图片收发极致体验等
* 技术的Geek想法落地，内部试用并不断丰富，最终反哺到业务，回馈用户。
  聊天机器人内部价值：
   IM系统报警，用户 VOC 问题解决率提醒，命令行重启单台机器等 提高工作效率。

##存储设计之道

* 架构设计理念-不同场景，不同架构   （个人Get - **树立多变场景的存储理念** )

  场景化特定设计示例   
  万人群（成员较多的聊天室控制）

  * 降低存储扩散量     
     将写扩散模型，优化为读扩散模型。减少写的次数，一条消息只写一次消息收件箱。
    实现 YY：*消息发送者：只会触发一条写的物理消息*
                    *其他群成员：满足读取条件时，查询对应群 ID的相关数据*

  * 智能限流

    由每个群设定最低发送阈值优化为系统达到上限阈值后对发送**频率较高**的**大群**进行限流。
    案例场景如：*对节日场景流量洪峰的控制*。

  * 万人群成员多级缓存
    * 万人群成员    成员数达到一定数量时开启？
    * 多级缓存   增强at(@)列表、群成员列表查看体验
       读写压力直接达到 DB，万行记录扩散量较大，容易造成热点
       客户端、服务端多级缓存；增强客户端缓存@列表立即响应
  * 端到端的体验保证
    定期做极限压测，保障群消息大规模刷屏不卡顿。
  * 

* 历史消息可回溯   (个人Get-**满足客户对数据资产的价值利用**)

  ToB场景，消息属于企业资产 （互联网时代，企业的数字资产）

  目标是 

  * 既省流量又不遗漏消息回溯的协议
    * 最近消息-采用同步协议推动到客户端
    * 历史消息-采用推拉协议，客户端发现消息不足时从服务端拉取补足。
      消息不足的场景YY:  总消息数量、用户过滤条件
  * 低成本历史消息存储架构
    消息具有冷热属性，采用冷热架构。冷消息采用低成本高压缩率的存储引擎，大幅降低存储成本
  * 金融级安全保障
    全链路使用**金融级**加密算法，不留死角。
  * 

* 场景化   (个人Get-**满足追求极致体验的产品设计**)
  ToC IM 产品场景较通用，每人可用功能集合一致， 如微信。
  ToB IM 产品场景 **钉钉策略**是面向**不同场景**打造**极致体验**。

  案例场景：家校场景
                     家长群-进群后昵称系统设置, 家长无法修改。
                     班级群-进群路径、群管理、昵称展示。

   技术挑战

  * 系统模型的可扩展性，必须做到扩展性强，足够灵活，能够快速支持业务场景化的需求。
  * 业务快速迭代情况下，核心 IM 系统的高可用性

   案例场景-班级群：

  ​	客户端，利用小程序特性：不发版实现bugf'ix、业务迭代。
  ​    服务端，切分业务层和IMCore层，实现灵活多变的业务逻辑，满足快速迭代。
  * 

* 单元化   表现在多层需求  （个人-**满足客户对服务部署的个性化需求**）

  * 高可用 - 保证 VIP 用户的地域容灾。有一套基于单元化的异地容灾方案，实现中心宕机 2min内一键将 VIP 用户调度到容灾单元，保障用户 IM基本功能。
  * 国际化- 海外地区对数据的有合规要求。
  * 支持大客户及特殊行业 -   满足中小政务客户的云部署能力
  * 容量    业务不断发展，中心处理方式不可取，将流量分散到多地域。

  单元化目标：一套代码不糊，一套运维体系实现单元化，满足多层次需求。
  高度复用及适配：基础设置支持，单元化基础组件、动态路由、业务层数据同步组件等。

  

  ###个人总结：

  * 不同场景，不同架构 ：  存储架构理念的诠释  **树立多变场景的存储理念**
  * 历史消息可回溯：  数字资产的维护   **满足客户对数据资产的价值利用**
  * 场景化： 根据业务场景的不同特征采用更合理的策略  **满足追求极致体验的产品设计**
  * 单元化：  针对存储的多层需求  **满足客户对服务部署的个性化**

  

## 高可用、安全性保证

###高可用

* 高可用架构：异地容灾、中间件冗余、存储冗余。

* 变更管理：核心系统控制发布频率，每次发布必须checklist校验。
                     发布可灰度、可监控、可回滚，控制问题引入的影响面。

* 持续精进：大故障有小隐患累计产生，需有机制性的解决问题。
                      如每天专人投入，去发现维护稳定性问题。

  **总结**：**框架设计保障，人员疏漏可控，技能操练不生**

  

### 安全性

* IM 全链路加密，银行级数据加密

   加密-客户端、长连接、mq、存储、业务上下游

   鉴权- 鉴权、访问控制

* 数据安全  企业选择第三方加密的支持。 数据可只属于企业。

* 长期的安全技术沉淀   
      安全扫描- 可扫描到一般的水平权限漏洞，将大部分问题扼杀在上线前。
  入侵事件响应- 分钟级事件定位及事件的快速响应、止血与溯源。

* 攻防演练  及时发现**潜在问题**，提升**入侵检测**及安全**应急响应**能力

**总结：敏感信息比企业考虑周全，信任度给足企业底气，实力能力值得企业认可**